<template>
  <div class="page-content infinite-scroll-content no-padding" @infinite=loadMore>
    <div data-name="services" id="services-tab">
      <div class="block">
        <div class="row">
          <div class="col-50">
            <img
              src="static/images/work.png"
              style="width: 100%; height: auto"
            />
          </div>
          <div class="col-50">
            <p class="text-color-gray text-align-justify no-margin">
              Conheça os serviços que o PRACTICE oferece!
            </p>
            <a
              href="/services/service-request/"
              class="button button-raised button-fill margin-top-half"
              >Solicitar serviço</a
            >
          </div>
        </div>
      </div>
  
      <div class="toolbar tabbar tabbar-scrollable toolbar-bottom" id="tabbar">
        <div class="toolbar-inner" id="toolbar_inner"><a href="#tab-1" class="tab-link tab-link-active">Aguardando Aprovação</a>
          <a href="#tab-2" class="tab-link">Em Progresso</a>
          <a href="#tab-3" class="tab-link">Fila de trabalho</a>
          <a href="#tab-4" class="tab-link">Aguardando revisão</a>
          <a href="#tab-5" class="tab-link">Concluídos</a>
          <a href="#tab-6" class="tab-link">Recusados</a>
        </div>
        <div id="arrow_tabbar">
          <i class="f7-icons" >chevron_right</i>
        </div>
      </div>
  
      <div class="tabs" id="tab-content">
        <div class="tab tab-active" id="tab-1">
          <!-- Active services -->
          <div class="card">
            <div class="list media-list no-margin">
              <ul>
                {{#if approvalServices}} {{#unless approvalServices.length}}
                <li class="item-content">
                  <div class="item-inner">
                    <div class="item-title">Nada para mostrar aqui...</div>
                    <div class="item-text no-wrap">
                      <a href="/services/service-request/"
                        >Clique aqui para solicitar um serviço!</a
                      >
                    </div>
                  </div>
                </li>
                {{else}} {{#each approvalServices}}
                <li>
                  <a href="/services/{{this.id}}/" class="item-link item-content">
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div
                          style="
                            color: var(--color-3);
                            position: absolute;
                            left: -9px;
                          "
                        >
                          &#8226;
                        </div>
                        <div class="item-title">{{this.title}}</div>
                        <div class="item-after">{{this.created_at}}</div>
                      </div>
                      <div class="item-text no-wrap">{{this.description}}</div>
                    </div>
                  </a>
                </li>
                {{/each}} {{/unless}} {{else}} 
                {{#each '123'}}
                <li>
                  <a
                    class="item-link item-content skeleton-text skeleton-effect-blink"
                  >
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div class="item-title">____________</div>
                        <div class="item-after">_____</div>
                      </div>
                      <div class="item-text no-wrap">
                        ____________________________________
                      </div>
                    </div>
                  </a>
                </li>
                {{/each}} {{/if}}
              </ul>
            </div>
          </div>
        </div>
        <div class="tab" id="tab-2">
          <!-- Progress services -->
          <div class="card">
            <div class="list media-list no-margin">
              <ul>
                {{#if progressServices}} {{#unless progressServices.length}}
                <li class="item-content">
                  <div class="item-inner">
                    <div class="item-title">Nada para mostrar aqui...</div>
                    <div class="item-text no-wrap">
                      <a href="/services/service-request/"
                        >Clique aqui para solicitar um serviço!</a
                      >
                    </div>
                  </div>
                </li>
                {{else}} {{#each progressServices}}
                <li>
                  <a href="/services/{{this.id}}/" class="item-link item-content">
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div
                          style="
                            color: var(--color-2);
                            position: absolute;
                            left: -9px;
                          "
                        >
                          &#8226;
                        </div>
                        <div class="item-title">{{this.title}}</div>
                        <div class="item-after">{{this.created_at}}</div>
                      </div>
                      <div class="item-text no-wrap">{{this.description}}</div>
                    </div>
                  </a>
                </li>
                {{/each}} {{/unless}} {{else}} {{#each '123'}}
                <li>
                  <a
                    class="item-link item-content skeleton-text skeleton-effect-blink"
                  >
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div class="item-title">____________</div>
                        <div class="item-after">_____</div>
                      </div>
                      <div class="item-text no-wrap">
                        ____________________________________
                      </div>
                    </div>
                  </a>
                </li>
                {{/each}} {{/if}}
              </ul>
            </div>
          </div>
        </div>
        <div class="tab" id="tab-3">
          <!-- In queue services -->
          <div class="card">
            <div class="list media-list no-margin">
              <ul>
                {{#if queueServices}} {{#unless queueServices.length}}
                <li class="item-content">
                  <div class="item-inner">
                    <div class="item-title">Nada para mostrar aqui...</div>
                    <div class="item-text no-wrap">
                      <a href="/services/service-request/"
                        >Clique aqui para solicitar um serviço!</a
                      >
                    </div>
                  </div>
                </li>
                {{else}} {{#each queueServices}}
                <li>
                  <a href="/services/{{this.id}}/" class="item-link item-content">
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div
                          style="
                            color: var(--color-2);
                            position: absolute;
                            left: -9px;
                          "
                        >
                          &#8226;
                        </div>
                        <div class="item-title">{{this.title}}</div>
                        <div class="item-after">{{this.created_at}}</div>
                      </div>
                      <div class="item-text no-wrap">{{this.description}}</div>
                    </div>
                  </a>
                </li>
                {{/each}} {{/unless}} {{else}} {{#each '123'}}
                <li>
                  <a
                    class="item-link item-content skeleton-text skeleton-effect-blink"
                  >
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div class="item-title">____________</div>
                        <div class="item-after">_____</div>
                      </div>
                      <div class="item-text no-wrap">
                        ____________________________________
                      </div>
                    </div>
                  </a>
                </li>
                {{/each}} {{/if}}
              </ul>
            </div>
          </div>
        </div>
        <div class="tab" id="tab-4">
          <!-- Review services -->
          <div class="card">
            <div class="list media-list no-margin">
              <ul>
                {{#if reviewServices}} {{#unless reviewServices.length}}
                <li class="item-content">
                  <div class="item-inner">
                    <div class="item-title">Nada para mostrar aqui...</div>
                    <div class="item-text no-wrap">
                      <a href="/services/service-request/"
                        >Clique aqui para solicitar um serviço!</a
                      >
                    </div>
                  </div>
                </li>
                {{else}} {{#each reviewServices}}
                <li>
                  <a href="/services/{{this.id}}/" class="item-link item-content">
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div
                          style="
                            color: var(--color-2);
                            position: absolute;
                            left: -9px;
                          "
                        >
                          &#8226;
                        </div>
                        <div class="item-title">{{this.title}}</div>
                        <div class="item-after">{{this.created_at}}</div>
                      </div>
                      <div class="item-text no-wrap">{{this.description}}</div>
                    </div>
                  </a>
                </li>
                {{/each}} {{/unless}} {{else}} {{#each '123'}}
                <li>
                  <a
                    class="item-link item-content skeleton-text skeleton-effect-blink"
                  >
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div class="item-title">____________</div>
                        <div class="item-after">_____</div>
                      </div>
                      <div class="item-text no-wrap">
                        ____________________________________
                      </div>
                    </div>
                  </a>
                </li>
                {{/each}} {{/if}}
              </ul>
            </div>
          </div>
        </div>
        <div class="tab" id="tab-5">
          <!-- Done services -->
          <div class="card">
            <div class="list media-list no-margin">
              <ul>
                {{#if doneServices}} {{#unless doneServices.length}}
                <li class="item-content">
                  <div class="item-inner">
                    <div class="item-title">Nada para mostrar aqui...</div>
                    <div class="item-text no-wrap">
                      <a href="/services/service-request/"
                        >Clique aqui para solicitar um serviço!</a
                      >
                    </div>
                  </div>
                </li>
                {{else}} {{#each doneServices}}
                <li>
                  <a href="/services/{{this.id}}/" class="item-link item-content">
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div
                          style="
                            color: var(--color-5);
                            position: absolute;
                            left: -9px;
                          "
                        >
                          &#8226;
                        </div>
                        <div class="item-title">{{this.title}}</div>
                        <div class="item-after">{{this.created_at}}</div>
                      </div>
                      <div class="item-text no-wrap">{{this.description}}</div>
                    </div>
                  </a>
                </li>
                {{/each}} {{/unless}} {{else}} {{#each '123'}}
                <li>
                  <a
                    class="item-link item-content skeleton-text skeleton-effect-blink"
                  >
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div class="item-title">____________</div>
                        <div class="item-after">_____</div>
                      </div>
                      <div class="item-text no-wrap">
                        ____________________________________
                      </div>
                    </div>
                  </a>
                </li>
                {{/each}} {{/if}}
              </ul>
            </div>
          </div>
        </div>
        <div class="tab" id="tab-6">
          <!-- Done services -->
          <div class="card">
            <div class="list media-list no-margin">
              <ul>
                {{#if refusedServices}} {{#unless refusedServices.length}}
                <li class="item-content">
                  <div class="item-inner">
                    <div class="item-title">Nada para mostrar aqui...</div>
                    <div class="item-text no-wrap">
                      <a href="/services/service-request/"
                        >Clique aqui para solicitar um serviço!</a
                      >
                    </div>
                  </div>
                </li>
                {{else}} {{#each refusedServices}}
                <li>
                  <a href="/services/{{this.id}}/" class="item-link item-content">
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div
                          style="
                            color: var(--f7-color-red);
                            position: absolute;
                            left: -9px;
                          "
                        >
                          &#8226;
                        </div>
                        <div class="item-title">{{this.title}}</div>
                        <div class="item-after">{{this.created_at}}</div>
                      </div>
                      <div class="item-text no-wrap">{{this.description}}</div>
                    </div>
                  </a>
                </li>
                {{/each}} {{/unless}} {{else}} {{#each '123'}}
                <li>
                  <a
                    class="item-link item-content skeleton-text skeleton-effect-blink"
                  >
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div class="item-title">____________</div>
                        <div class="item-after">_____</div>
                      </div>
                      <div class="item-text no-wrap">
                        ____________________________________
                      </div>
                    </div>
                  </a>
                </li>
                {{/each}} {{/if}}
              </ul>
            </div>
          </div>
        </div>
      </div>
  
    </div>
  </div>
</template>

<style>
  #tab-content{
    overflow-y: scroll;
  }
  #tabbar{
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.22);
  }
  #arrow_tabbar{
    position: absolute;
    display: flex;
    height: 100%;
    width: var(--f7-toolbar-height);
    align-items: center;
    right: 0px;
    color: rgba(38, 70, 83, 0.8);
    background-image: linear-gradient(to left, white, white, white, rgba(255,255,255,0));
    z-index: 99;
  }
  #arrow_tabbar i{
    font-size: 20px;
    margin: auto 5px auto auto;
  }

</style>

<script>
  import 'dom7/dist/dom7.js';

  export default {
    data: function () {
      return {
        approvalServices : null,
        progressServices : null,
        queueServices: null,
        reviewServices: null,
        doneServices : null,
        refusedServices : null,
        nextPage: null
      };
    },
    methods: {
      loadMore: function () {
        this.loadServices()
        console.log(this.nextPage)
      },
      loadServices: function () {
        var self = this;
        var app = self.$app;
        app.storage
          .getRequestedServices(this.nextPage)
          .then((res) => {
            if (res.meta.last_page != this.nextPage) {
              this.nextPage = res.meta.current_page + 1;
            }
            this.separateServices(res.services);
          })
          .catch(() => {
            let services = app.storage.getRequestedServicesFromLocalstorage();
            if (services) {
              this.separateServices(services);
            }
            app.dialog.alert(
              "Ocorreu um erro ao carregar estes dados, tente novamente!"
            );
          });
      },
      separateServices: function ( services ) {
        var self = this;
        var app = self.$app;
        
        // Processing data
        let approvalServices = new Array();
        let progressServices = new Array();
        let queueServices = new Array();
        let reviewServices = new Array();
        let doneServices = new Array();
        let refusedServices = new Array();

        for (let i = 0; i < services.length; i++) {
          if (services[i].status === null){
            approvalServices.push(services[i]);
          } else if (services[i].status === 'doing'){
            progressServices.push(services[i]);
          } else if (services[i].status === 'todo'){
            queueServices.push(services[i]);
          } else if (services[i].status === 'review'){
            reviewServices.push(services[i]);
          }else if (services[i].status === 'completed'){
            doneServices.push(services[i]);
          } else if (services[i].status === 'closed'){
            refusedServices.push(services[i]);
          }
        }
        self.resizeListServices();
        
        self.$setState({
          approvalServices : approvalServices,
          progressServices : progressServices,
          queueServices : queueServices,
          reviewServices : reviewServices,
          doneServices : doneServices,
          refusedServices : refusedServices,
        });
      },
      resizeListServices : function () {
        var screen = Dom7('#services');
        var screen_size = screen.height()-screen.css('padding-top').replace("px", "")-screen.css('padding-bottom').replace("px", "");
        let content_size = Dom7('#services-tab').height()+32-Dom7('#tab-content').height();
        let max_list_size = screen_size - content_size;
        Dom7('#tab-content').css("height", max_list_size+"px");
      },
      animateArrow : function () {
        let arrow = Dom7("#arrow_tabbar");
        Dom7("#toolbar_inner").on('touchstart', () => {

          arrow.animate(
            {
              'opacity' : 0,
            },
            {
              duration: 50,
              easing: "linear"
            }
          );

          setTimeout(() => {
            arrow.css("display", "none");
          }, 50)
        });

        Dom7("#toolbar_inner").on('touchend', () => {
          arrow.css("display", "flex");
          arrow.animate(
            {
              'opacity': 1,
            },
            {
              duration: 50,
              easing: "linear"
            }
          )
        });
      }
    },
    on: {
      tabInit: function (e, page) {
        this.nextPage = 1;
        this.loadServices();

        this.animateArrow();
      },
    },
  };
</script>
