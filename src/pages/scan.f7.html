<template>
  <div data-name="scan">
    <div class="block card no-margin no-padding">
        <div id="qr-reader"></div>

        <div class="drop"></div>
        
        <div id="qr-reader-results">
          <div class="list media-list no-margin">
            <ul>

            </ul>
          </div>           
        </div>
    </div>
  </div>
</template>

<style>
  #qr-reader{
    width: 100%;
  }
  #qr-reader-results{
    overflow-y: scroll;
  }
  .drop {
    position: absolute;
    right: calc(50% - 15px);
    background-color: #2e749e;
    height: 30px;
    width: 30px;
    border-radius: 50% 50%;
    box-shadow: inset -25px 10px 0px -10px #0288d1;
    z-index: 99;
    margin: auto;
    transition: transform 0.5s linear;
    display: none;
    transform: rotate(45deg);
  }
  .move {
    border-radius: 0% 50% 50% 50%;
  }
</style>

<script>
  import 'html5-qrcode/minified/html5-qrcode.min.js';
  import 'dom7/dist/dom7.js';

  //TODO: fazer direcionamentos de texte nos itens

  export default {
    data: function () {
      return {
        scanner: null,
        data_scanned: Array(),
        items: ['teste 1', 'teste 2']
      }
    },
    methods: {
      getCamPermission: function (){
        document.addEventListener('deviceready', function () {
            app.permissions = cordova.plugins.permissions;
            app.permissions.checkPermission("android.permission.CAMERA", function (status) {
              console.log('success checking permission');
              console.log('Has CAMERA:', status.hasPermission);
              if (!status.hasPermission) {
                app.permissions.requestPermission("android.permission.CAMERA", function (status) {
                    console.log('success requesting CAMERA permission');
                }, function (err) {
                    console.log('failed to set permission');
                });
              }
            }, function (err) {
              console.log(err);
            });
        });
      },
      initScan: function () {
        let self = this;
        let app = self.$app;

        this.scanner = new Html5Qrcode("qr-reader");
        const config = { fps: 3, qrbox: 200, aspectRatio : 0.8 };

        var scanStart = new Promise((resolve, reject) => {  
          this.scanner.start(
            { facingMode: "environment" },
            config,
            qrCodeMessage => {
              this.addContent(qrCodeMessage);
            },
            errorMessage => { resolve(true) }) //EstÃ¡ lendo
          .catch(err => {
            console.log(`Unable to start scanning, error: ${err}`);
            reject(err);
          })
        });
        scanStart.then(function(res) {
          var screen = Dom7('#scan')
          var scanner_size = Dom7('#qr-reader').height();
          var screen_size = screen.height()-screen.css('padding-top').replace("px", "")-screen.css('padding-bottom').replace("px", "");
          Dom7('#qr-reader-results').css("height", screen_size-scanner_size+"px");
        })
      },
      removeScan: function () {
        this.scanner.stop().then(ignore => {
          console.log(`Stop Scan`);
        }).catch(err => {
          console.log(`Unable to stop scanning, error: ${err}`);
        });
      },
      
      animationAddContent: function () {
        var drop = Dom7('.drop');
        var deslocation = Dom7('#qr-reader').height();
        var initialPos = (deslocation/2).toString()+'px';
        this.setDropInitialPos(drop, initialPos);

        drop
        .animate(
        {
          'top': deslocation+20,
        },
        {
          duration: 1000,
          easing: 'swing',
        }).animate(
          {
            'opacity': 0,
          },
          {
            duration: 500
          }
        )

        this.setDropEndPos(drop, initialPos);
      },

      setDropInitialPos: function(drop, initialPos) {
        drop.css("display", "block");
        drop.css("opacity", "1");
        drop.css("top", initialPos);
        setTimeout(function () { drop.addClass("move");}, 0);
      },

      setDropEndPos: function(drop, initialPos) {
        setTimeout(function (){
          drop.css("display", "none");
          drop.css("opacity", "1");
          drop.css("top", initialPos);
          drop.removeClass("move");
        }, 2000)
      },

      addContent: function (content) {
        if(this.data_scanned.indexOf(content) != -1 || content.trim() == ""){
        }
        else{
          this.data_scanned.unshift(content);
          this.animationAddContent();

          var dad = document.getElementById('qr-reader-results').childNodes[0].childNodes[0];
          var text = '';

          this.data_scanned.forEach(element => {
            var link = ""; // ex: '/env/'
            var title = "";
            var description = "";
            title = element;
            text += `<li class="item"><a href="${link}" class="item-link item-content"> 
              <div class="item-inner">
                <div class="item-title-row">
                  <div class="item-title">${title}</div>
                </div>
                <div class="item-text no-wrap">${description}</div>
              </div>
            </a></li>`;
          });
          dad.innerHTML = text;
          var item = Dom7('.item');
          
          document.getElementsByClassName('item')[0].style.opacity = 0;
          item.animate({
            'opacity': 1,
          },
          {
            duration: 1000,
            easing: 'swing'
          })
          
          navigator.vibrate([500]);
        }
      }
    },
    on: {
      tabInit: function(e, page) {
        var gotOpen = new Promise((resolve, reject) => {
          resolve(this.getCamPermission());
        })
        gotOpen.then((res) => {
          this.initScan();
        })
      },
      tabBeforeRemove: function (e) {
        if(Dom7('#qr-shaded-region').length != 0){
          this.removeScan();
        }
      }
    }
  }
</script>